<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8" />

<style>
	html,body{margin:0;padding:0;overflow:hidden;height:100%;}
	label,textarea{position:absolute;z-index:10;transform:translateX(-50%);}
	#model_axisangle_label{      position:absolute;left:10%;width:20%;top: 0px;color:white;}
	#model_axisangle_textarea{   position:absolute;left:10%;width:20%;top:20px;}
	#model_quaternion_label{     position:absolute;left:10%;width:20%;top:40px;color:white;}
	#model_quaternion_textarea{  position:absolute;left:10%;width:20%;top:60px;}
	#model_matrix_label {        position:absolute;left:10%;width:20%;top:80px;color:white;}
	#model_matrix_textarea {     position:absolute;left:10%;width:20%;top:100px;}

	#camera_position_label{      position:absolute;left:90%;width:20%;top:  0px;color:white;}
	#camera_position_textarea{   position:absolute;left:90%;width:20%;top: 20px;}
	#camera_axisangle_label{     position:absolute;left:90%;width:20%;top: 40px;color:white;}
	#camera_axisangle_textarea{  position:absolute;left:90%;width:20%;top: 60px;}
	#camera_quaternion_label{    position:absolute;left:90%;width:20%;top: 80px;color:white;}
	#camera_quaternion_textarea{ position:absolute;left:90%;width:20%;top:100px;}
	#camera_matrix_label {       position:absolute;left:90%;width:20%;top:120px;color:white;}
	#camera_matrix_textarea {    position:absolute;left:90%;width:20%;top:140px;}

	#proj_inverse_full_label{     position:absolute;left:35%;width:16%;bottom:100px;color:white;}
	#proj_inverse_full_textarea{  position:absolute;left:35%;width:16%;bottom:120px;}
	#camera_inverse_full_label{   position:absolute;left:60%;width:16%;bottom:100px;color:white;}
	#camera_inverse_full_textarea{position:absolute;left:60%;width:16%;bottom:120px;}
	#model_inverse_full_label{    position:absolute;left:85%;width:16%;bottom:100px;color:white;}
	#model_inverse_full_textarea{ position:absolute;left:85%;width:16%;bottom:120px;}

	#local_inverse_label{       position:absolute;left:96%;width:4%;bottom:100px;color:white;}
	#local_inverse_textarea{    position:absolute;left:96%;width:4%;bottom:120px;}
	#world_inverse_label{       position:absolute;left:72%;width:4%;bottom:100px;color:white;}
	#world_inverse_textarea{    position:absolute;left:72%;width:4%;bottom:120px;}
	#view_inverse_label{        position:absolute;left:48%;width:4%;bottom:100px;color:white;}
	#view_inverse_textarea{     position:absolute;left:48%;width:4%;bottom:120px;}
	#clip_inverse_label{        position:absolute;left:22%;width:4%;bottom:100px;color:white;}
	#clip_inverse_textarea{     position:absolute;left:22%;width:4%;bottom:120px;}
	#ndc_inverse_label{         position:absolute;left:16%;width:4%;bottom:100px;color:white;}
	#ndc_inverse_textarea{      position:absolute;left:16%;width:4%;bottom:120px;}
	#vp_inverse_label{          position:absolute;left:10%;width:4%;bottom:100px;color:white;}
	#vp_inverse_textarea{       position:absolute;left:10%;width:4%;bottom:120px;}

	#proj_matrix_full_label{      position:absolute;left:35%;width:16%;bottom: 0px;color:white;}
	#proj_matrix_full_textarea{   position:absolute;left:35%;width:16%;bottom:20px;}
	#camera_matrix_full_label{    position:absolute;left:60%;width:16%;bottom: 0px;color:white;}
	#camera_matrix_full_textarea{ position:absolute;left:60%;width:16%;bottom:20px;}
	#model_matrix_full_label{     position:absolute;left:85%;width:16%;bottom: 0px;color:white;}
	#model_matrix_full_textarea{  position:absolute;left:85%;width:16%;bottom:20px;}

	#local_position_label{       position:absolute;left:96%;width:4%;bottom: 0px;color:white;}
	#local_position_textarea{    position:absolute;left:96%;width:4%;bottom:20px;}
	#world_position_label{       position:absolute;left:72%;width:4%;bottom: 0px;color:white;}
	#world_position_textarea{    position:absolute;left:72%;width:4%;bottom:20px;}
	#view_position_label{        position:absolute;left:48%;width:4%;bottom: 0px;color:white;}
	#view_position_textarea{     position:absolute;left:48%;width:4%;bottom:20px;}
	#clip_position_label{        position:absolute;left:22%;width:4%;bottom: 0px;color:white;}
	#clip_position_textarea{     position:absolute;left:22%;width:4%;bottom:20px;}
	#ndc_position_label{         position:absolute;left:16%;width:4%;bottom: 0px;color:white;}
	#ndc_position_textarea{      position:absolute;left:16%;width:4%;bottom:20px;}
	#vp_position_label{          position:absolute;left:10%;width:4%;bottom: 0px;color:white;}
	#vp_position_textarea{       position:absolute;left:10%;width:4%;bottom:20px;}
	#fb_position_label{          position:absolute;left:4%;width:4%;bottom:40px;color:white;}
	#fb_position_textarea{       position:absolute;left:4%;width:4%;bottom:60px;}
</style>

</head>
<body onload="birth()" onresize="resize()">

<canvas id="canvas" ondragover="allowDrop(event)" ondrop="dropfile(event)" onkeydown="keydown(event)" onmousewheel="mousewheel(event)" onmousedown="mousedown(event)" onmouseup="mouseup(event)" onmousemove="mousemove(event)"  ontouchstart="mousedown(event)" ontouchend="mouseup(event)" ontouchmove="touchmove(event)">
</canvas>

<label id="model_axisangle_label">model_axisangle</label>
<textarea id="model_axisangle_textarea" rows="1" cols="30" onkeydown="model_aa_keydown(event)"></textarea>
<label id="model_quaternion_label">model_quaternion</label>
<textarea id="model_quaternion_textarea" rows="1" cols="30"></textarea>
<label id="model_matrix_label">model_matrix_rotate</label>
<textarea id="model_matrix_textarea" rows="5" cols="30"></textarea>

<label id="camera_position_label">camera_position</label>
<textarea id="camera_position_textarea" rows="1" cols="30"></textarea>
<label id="camera_axisangle_label">camera_axisangle</label>
<textarea id="camera_axisangle_textarea" rows="1" cols="30" onkeydown="camera_aa_keydown(event)"></textarea>
<label id="camera_quaternion_label">camera_quaternion</label>
<textarea id="camera_quaternion_textarea" rows="1" cols="30"></textarea>
<label id="camera_matrix_label">camera_matrix_rotate</label>
<textarea id="camera_matrix_textarea" rows="5" cols="30"></textarea>

<label id="proj_inverse_full_label">proj_inverse</label>
<textarea id="proj_inverse_full_textarea" rows="4" cols="30"></textarea>
<label id="camera_inverse_full_label">camera_inverse</label>
<textarea id="camera_inverse_full_textarea" rows="4" cols="30"></textarea>
<label id="model_inverse_full_label">model_inverse</label>
<textarea id="model_inverse_full_textarea" rows="4" cols="30"></textarea>

<label id="local_inverse_label">local_position</label>
<textarea id="local_inverse_textarea" rows="4" cols="30"></textarea>
<label id="world_inverse_label">world_inverse</label>
<textarea id="world_inverse_textarea" rows="4" cols="30"></textarea>
<label id="view_inverse_label">view_inverse</label>
<textarea id="view_inverse_textarea" rows="4" cols="30"></textarea>
<label id="clip_inverse_label">clip_inverse</label>
<textarea id="clip_inverse_textarea" rows="4" cols="30"></textarea>
<label id="ndc_inverse_label">ndc_inverse</label>
<textarea id="ndc_inverse_textarea" rows="4" cols="30"></textarea>
<label id="vp_inverse_label">vp_inverse</label>
<textarea id="vp_inverse_textarea" rows="4" cols="30"></textarea>

<label id="proj_matrix_full_label">proj_matrix</label>
<textarea id="proj_matrix_full_textarea" rows="4" cols="30"></textarea>
<label id="camera_matrix_full_label">camera_matrix</label>
<textarea id="camera_matrix_full_textarea" rows="4" cols="30"></textarea>
<label id="model_matrix_full_label">model_matrix</label>
<textarea id="model_matrix_full_textarea" rows="4" cols="30"></textarea>

<label id="local_position_label">local_position</label>
<textarea id="local_position_textarea" rows="4" cols="30"></textarea>
<label id="world_position_label">world_position</label>
<textarea id="world_position_textarea" rows="4" cols="30"></textarea>
<label id="view_position_label">view_position</label>
<textarea id="view_position_textarea" rows="4" cols="30"></textarea>
<label id="clip_position_label">clip_position</label>
<textarea id="clip_position_textarea" rows="4" cols="30"></textarea>
<label id="ndc_position_label">ndc_position</label>
<textarea id="ndc_position_textarea" rows="4" cols="30"></textarea>
<label id="vp_position_label">vp_position</label>
<textarea id="vp_position_textarea" rows="4" cols="30"></textarea>
<label id="fb_position_label">fb_position</label>
<textarea id="fb_position_textarea" rows="4" cols="30"></textarea>

<script id="vshader" type="x-shader/x-vertex">#version 300 es
layout(location = 0)in vec3 n;
layout(location = 1)in vec3 v;
layout(location = 2)in vec3 c;
out vec3 vertex;
out vec3 normal;
out vec3 coulor;
uniform mat4 model;
uniform mat4 view;
uniform mat4 proj;
void main(void) {
	vertex = v;
	normal = n;
	coulor = c;
	gl_Position = proj * view * model * vec4(v, 1.0);
}
</script>
<script id="fshader" type="x-shader/x-fragment">#version 300 es
precision mediump float;
in vec3 vertex;
in vec3 normal;
in vec3 coulor;
out vec4 FragColor;
uniform vec3 camxyz;
mediump vec3 sunxyz = vec3(400.0, 200.0, 1000.0);
mediump vec3 lightcolor = vec3(1.0, 1.0, 1.0);
mediump vec3 kambi = vec3(0.231250, 0.231250, 0.231250);
mediump vec3 kdiff = vec3(0.277500, 0.277500, 0.277500);
mediump vec3 kspec = vec3(0.773911, 0.773911, 0.773911);
vec3 phong(){
	mediump vec3 N = normalize(normal);
	mediump vec3 L = normalize(sunxyz - vertex);
	mediump float SN = max(dot(N, L), 0.0);
	mediump vec3 ret = kambi + kdiff*SN;
	if(SN>0.0){
		mediump vec3 E = normalize(camxyz - vertex);
		mediump vec3 H = normalize(E + L);
		mediump float NH = max(dot(N, H), 0.0);
		ret += kspec*pow(NH, 89.6);
	}
	return lightcolor * coulor * ret;
}
//float shadow(){
	//if(uvw.z - texture(tex0, uvw.xy).r > 0.000001)return 0.1;
	//return 1.0;
//}
void main(){
	//FragColor = vec4(phong()*shadow(), 1.0);
	FragColor = vec4(phong(), 1.0);
}
</script>

<script type="text/javascript">
var windowwidth = 512;
var windowheight = 512;
function resize()
{
	windowwidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
	windowheight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
	document.getElementById("canvas").width = windowwidth;
	document.getElementById("canvas").height = windowheight;
}
//
var axishandle;
var axisdata = [
	-1000.0,     0.0,     0.0, 0.5, 0.5, 1.0,
	 1000.0,     0.0,     0.0, 0.5, 0.5, 1.0,
	    0.0, -1000.0,     0.0, 0.5, 1.0, 0.5,
	    0.0,  1000.0,     0.0, 0.5, 1.0, 0.5,
	    0.0,     0.0, -1000.0, 1.0, 0.5, 0.5,
	    0.0,     0.0,  1000.0, 1.0, 0.5, 0.5
];
//
var vertexhandle;
var vertexdata = [
	//l
	-1.0,-1.0,-1.0,-1.0, 0.0, 0.0, 0.8, 0.8, 1.0,
	-1.0, 1.0,-1.0,-1.0, 0.0, 0.0, 0.8, 0.8, 1.0,
	-1.0,-1.0, 1.0,-1.0, 0.0, 0.0, 0.8, 0.8, 1.0,
	-1.0, 1.0, 1.0,-1.0, 0.0, 0.0, 0.8, 0.8, 1.0,

	//r
	 1.0,-1.0,-1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0,
	 1.0, 1.0,-1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0,
	 1.0,-1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0,
	 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0,

	//n
	-1.0,-1.0,-1.0, 0.0,-1.0, 0.0, 0.8, 1.0, 0.8,
	 1.0,-1.0,-1.0, 0.0,-1.0, 0.0, 0.8, 1.0, 0.8,
	-1.0,-1.0, 1.0, 0.0,-1.0, 0.0, 0.8, 1.0, 0.8,
	 1.0,-1.0, 1.0, 0.0,-1.0, 0.0, 0.8, 1.0, 0.8,

	//f
	-1.0, 1.0,-1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0,
	 1.0, 1.0,-1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0,
	-1.0, 1.0, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0,
	 1.0, 1.0, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0,

	//b
	-1.0,-1.0,-1.0, 0.0, 0.0,-1.0, 1.0, 0.8, 0.8,
	 1.0,-1.0,-1.0, 0.0, 0.0,-1.0, 1.0, 0.8, 0.8,
	-1.0, 1.0,-1.0, 0.0, 0.0,-1.0, 1.0, 0.8, 0.8,
	 1.0, 1.0,-1.0, 0.0, 0.0,-1.0, 1.0, 0.8, 0.8,

	//t
	-1.0,-1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0,
	 1.0,-1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0,
	-1.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0,
	 1.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0
];
var indexhandle;
var indexdata = [
	 0, 1, 2,	 1, 3, 2,
	 4, 5, 6,	 5, 7, 6,
	 8, 9,10,	 9,11,10,
	12,13,14,	13,15,14,
	16,17,18,	17,19,18,
	20,21,22,	21,23,22,
	24,25,26,	25,27,26
];
//
var stlhandle;
var arraybuffer;
var stlpointcount=0;
//
function allowDrop(event)
{
	event.preventDefault();
}
function dropfile(event)
{
	event.preventDefault();

	var file = event.dataTransfer.files[0];
	console.log(file);

	var reader = new FileReader();
	reader.onload = function(ev) {
		//
		arraybuffer = reader.result;
		if(arraybuffer.byteLength < 1000)
		{
			stlpointcount = 0;
			return;
		}

		//
		var dataview = new DataView(arraybuffer);
		stlpointcount = dataview.getUint32(80, true);
		console.log(stlpointcount);

		//
		var tempdata = new Float32Array(stlpointcount * 18);
		for(var j=0;j<stlpointcount;j++)
		{
			tempdata[j*18 + 0] = dataview.getFloat32(j*50 + 84, true);
			tempdata[j*18 + 1] = dataview.getFloat32(j*50 + 88, true);
			tempdata[j*18 + 2] = dataview.getFloat32(j*50 + 92, true);
			tempdata[j*18 + 3] = dataview.getFloat32(j*50 + 96, true);
			tempdata[j*18 + 4] = dataview.getFloat32(j*50 + 100, true);
			tempdata[j*18 + 5] = dataview.getFloat32(j*50 + 104, true);

			tempdata[j*18 + 6] = dataview.getFloat32(j*50 + 84, true);
			tempdata[j*18 + 7] = dataview.getFloat32(j*50 + 88, true);
			tempdata[j*18 + 8] = dataview.getFloat32(j*50 + 92, true);
			tempdata[j*18 + 9] = dataview.getFloat32(j*50 + 108, true);
			tempdata[j*18 + 10] = dataview.getFloat32(j*50 + 112, true);
			tempdata[j*18 + 11] = dataview.getFloat32(j*50 + 116, true);

			tempdata[j*18 + 12] = dataview.getFloat32(j*50 + 84, true);
			tempdata[j*18 + 13] = dataview.getFloat32(j*50 + 88, true);
			tempdata[j*18 + 14] = dataview.getFloat32(j*50 + 92, true);
			tempdata[j*18 + 15] = dataview.getFloat32(j*50 + 120, true);
			tempdata[j*18 + 16] = dataview.getFloat32(j*50 + 124, true);
			tempdata[j*18 + 17] = dataview.getFloat32(j*50 + 128, true);
		}

		//
		stlhandle = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, stlhandle);
		gl.bufferData(gl.ARRAY_BUFFER, tempdata, gl.STATIC_DRAW);
	}
	reader.readAsArrayBuffer(file);
}

var gl;
var shaderProgram;
var positionobject;
var normalobject;
function initwebgl(canvas) {
	var canvas = document.getElementById('canvas');
	gl = canvas.getContext('webgl2');

	if (!gl) {
		alert("抱歉，不能初始化webGL！");
	}
}
function getShader(gl, id) {
	var shaderScript = document.getElementById(id);
	if(!shaderScript)return null;

	var str = "";
	var k = shaderScript.firstChild;
	while (k) {
		if (k.nodeType == 3)str += k.textContent;
		k = k.nextSibling;
	}

	var shader;
	if (shaderScript.type == "x-shader/x-fragment") {
		shader = gl.createShader(gl.FRAGMENT_SHADER);
	}
	else if (shaderScript.type == "x-shader/x-vertex") {
		shader = gl.createShader(gl.VERTEX_SHADER);
	}
	else return null;

	gl.shaderSource(shader, str);
	gl.compileShader(shader);

	if(!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
		alert(gl.getShaderInfoLog(shader));
	return null;
	}

	return shader;
}
function initshaders() {
	var vertexShader = getShader(gl, "vshader");
	var fragmentShader = getShader(gl, "fshader");

	shaderProgram = gl.createProgram();
	gl.attachShader(shaderProgram, vertexShader);
	gl.attachShader(shaderProgram, fragmentShader);
	gl.linkProgram(shaderProgram);

	if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
		alert("Could not initialise shaders");
	}
	gl.useProgram(shaderProgram);

	positionobject = gl.getAttribLocation(shaderProgram, "v");
	normalobject = gl.getAttribLocation(shaderProgram, "n");
	colorobject = gl.getAttribLocation(shaderProgram, "c");
}

model_axan = new Float32Array([
	0.0, 0.0, 1.0, 20.0
]);
model_quat = new Float32Array([
	0.0, 0.0, 1.0, 0.0
]);
modelmatrix = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0,
	0.0, 0.0, 0.0, 1.0
]);
modelinverse = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0,
	0.0, 0.0, 0.0, 1.0
]);
function setmodelmatrix(aa)
{
	var c = Math.cos(aa[3]*Math.PI/180/2);
	var s = Math.sin(aa[3]*Math.PI/180/2);
	var invsqrt = 1.0 / Math.sqrt(aa[0]*aa[0] + aa[1]*aa[1] + aa[2]*aa[2]);
	model_quat = [s*aa[0]*invsqrt, s*aa[1]*invsqrt, s*aa[2]*invsqrt, c];

	//
	modelmatrix[ 0] = 1.0 - (model_quat[1]*model_quat[1] + model_quat[2]*model_quat[2]) * 2.0;
	modelmatrix[ 1] =       (model_quat[0]*model_quat[1] - model_quat[2]*model_quat[3]) * 2.0;
	modelmatrix[ 2] =       (model_quat[0]*model_quat[2] + model_quat[1]*model_quat[3]) * 2.0;
	modelmatrix[ 3] = 0.0;

	modelmatrix[ 4] =       (model_quat[0]*model_quat[1] + model_quat[2]*model_quat[3]) * 2.0;
	modelmatrix[ 5] = 1.0 - (model_quat[0]*model_quat[0] + model_quat[2]*model_quat[2]) * 2.0;
	modelmatrix[ 6] =       (model_quat[1]*model_quat[2] - model_quat[0]*model_quat[3]) * 2.0;
	modelmatrix[ 7] = 0.0;

	modelmatrix[ 8] =       (model_quat[0]*model_quat[2] - model_quat[1]*model_quat[3]) * 2.0;
	modelmatrix[ 9] =       (model_quat[1]*model_quat[2] + model_quat[0]*model_quat[3]) * 2.0;
	modelmatrix[10] = 1.0 - (model_quat[0]*model_quat[0] + model_quat[1]*model_quat[1]) * 2.0;
	modelmatrix[11] = 0.0;

	modelmatrix[12] = 0.0;
	modelmatrix[13] = 0.0;
	modelmatrix[14] = 0.0;
	modelmatrix[15] = 1.0;

	//
	modelinverse[ 0] = 1.0 - (model_quat[1]*model_quat[1] + model_quat[2]*model_quat[2]) * 2.0;
	modelinverse[ 1] =       (model_quat[0]*model_quat[1] + model_quat[2]*model_quat[3]) * 2.0;
	modelinverse[ 2] =       (model_quat[0]*model_quat[2] - model_quat[1]*model_quat[3]) * 2.0;
	modelinverse[ 3] = 0.0;

	modelinverse[ 4] =       (model_quat[0]*model_quat[1] - model_quat[2]*model_quat[3]) * 2.0;
	modelinverse[ 5] = 1.0 - (model_quat[0]*model_quat[0] + model_quat[2]*model_quat[2]) * 2.0;
	modelinverse[ 6] =       (model_quat[1]*model_quat[2] + model_quat[0]*model_quat[3]) * 2.0;
	modelinverse[ 7] = 0.0;

	modelinverse[ 8] =       (model_quat[0]*model_quat[2] + model_quat[1]*model_quat[3]) * 2.0;
	modelinverse[ 9] =       (model_quat[1]*model_quat[2] - model_quat[0]*model_quat[3]) * 2.0;
	modelinverse[10] = 1.0 - (model_quat[0]*model_quat[0] + model_quat[1]*model_quat[1]) * 2.0;
	modelinverse[11] = 0.0;

	modelinverse[12] = 0.0;
	modelinverse[13] = 0.0;
	modelinverse[14] = 0.0;
	modelinverse[15] = 1.0;
}
function setmatrix_model(type)
{
	if(type == 0){
		var aa = [0,0,1, 0];
		setmodelmatrix(aa);
	}
	else{
		setmodelmatrix(model_axan);
		updateui_model(model_axan);
	}
	gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, "model"), true, modelmatrix);
}

var camerax = 0.0;
var cameray =-10.0;
var cameraz = 0.0;
var centerx = 0.0;
var centery = 0.0;
var centerz = 0.0;
var abovex = 0.0;
var abovey = 0.0;
var abovez = 1.0;
camera_axan = new Float32Array([
	0.0, 0.0, 1.0, 20.0
]);
camera_quat = new Float32Array([
	0.0, 0.0, 1.0, 0.0
]);
viewmatrix = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0, 
	0.0, 0.0, 0.0, 1.0
]);
camerainverse = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0, 
	0.0, 0.0, 0.0, 1.0
]);
function setmatrix_view()
{
	var norm;

	//Z = center - camera
	var nx = centerx - camerax;
	var ny = centery - cameray;
	var nz = centerz - cameraz;
	norm = Math.sqrt(nx*nx + ny*ny + nz*nz);
	nx /= norm;
	ny /= norm;
	nz /= norm;

	//X = cross(Z, above)
	var ux = ny*abovez - nz*abovey;
	var uy = nz*abovex - nx*abovez;
	var uz = nx*abovey - ny*abovex;
	norm = Math.sqrt(ux*ux + uy*uy + uz*uz);
	ux /= norm;
	uy /= norm;
	uz /= norm;

	//above = cross(X, Z)
	var vx = uy*nz - uz*ny;
	var vy = uz*nx - ux*nz;
	var vz = ux*ny - uy*nx;

	//axisangle = cross(oldvec, newvec)
	var tmpx = 1*nz - 0*ny;
	var tmpy = 0*nx - 0*nz;
	var tmpz = 0*ny - 1*nx;
	var tmpl = Math.sqrt(tmpx*tmpx + tmpy*tmpy + tmpz*tmpz);
	var angle = Math.asin(tmpl);
	camera_axan = [tmpx/tmpl, tmpy/tmpl, tmpz/tmpl, angle*180/Math.PI];

	//quaternion
	var c = Math.cos(angle/2);	//divide by 2: it's quaternion
	var s = Math.sin(angle/2);
	camera_quat[0] = camera_axan[0]*s;
	camera_quat[1] = camera_axan[1]*s;
	camera_quat[2] = camera_axan[2]*s;
	camera_quat[3] = c;

	//rotatematrix
	viewmatrix[ 0] = ux;
	viewmatrix[ 1] = nx;
	viewmatrix[ 2] = vx;
	viewmatrix[ 3] = 0.0;

	viewmatrix[ 4] = uy;
	viewmatrix[ 5] = ny;
	viewmatrix[ 6] = vy;
	viewmatrix[ 7] = 0.0;

	viewmatrix[ 8] = uz;
	viewmatrix[ 9] = nz;
	viewmatrix[10] = vz;
	viewmatrix[11] = 0.0;

	viewmatrix[12] = 0.0;
	viewmatrix[13] = 0.0;
	viewmatrix[14] = 0.0;
	viewmatrix[15] = 1.0;

	updateui_camera();


	//matrix: X-above-far
	viewmatrix[ 0] = ux;
	viewmatrix[ 1] = uy;
	viewmatrix[ 2] = uz;
	viewmatrix[ 3] = -camerax*ux - cameray*uy - cameraz*uz;

	viewmatrix[ 4] = vx;
	viewmatrix[ 5] = vy;
	viewmatrix[ 6] = vz;
	viewmatrix[ 7] = -camerax*vx - cameray*vy - cameraz*vz;

	viewmatrix[ 8] = nx;
	viewmatrix[ 9] = ny;
	viewmatrix[10] = nz;
	viewmatrix[11] = -camerax*nx - cameray*ny - cameraz*nz;

	viewmatrix[12] = 0.0;
	viewmatrix[13] = 0.0;
	viewmatrix[14] = 0.0;
	viewmatrix[15] = 1.0;

	//inverse: uvn -> rft
	camerainverse[ 0] = ux;
	camerainverse[ 1] = vx;
	camerainverse[ 2] = nx;
	camerainverse[ 3] = camerax;

	camerainverse[ 4] = uy;
	camerainverse[ 5] = vy;
	camerainverse[ 6] = ny;
	camerainverse[ 7] = cameray;

	camerainverse[ 8] = uz;
	camerainverse[ 9] = vz;
	camerainverse[10] = nz;
	camerainverse[11] = cameraz;

	camerainverse[12] = 0.0;
	camerainverse[13] = 0.0;
	camerainverse[14] = 0.0;
	camerainverse[15] = 1.0;

}

projmatrix = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, -1.0, -1.0,
	0.0, 0.0, -0.2, 0.0
]);
projinverse = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0,
	0.0, 0.0, 1.0, 0.0
]);
function setprojmatrix()
{
	var l =-0.001;
	var r = 0.001;
	var b =-0.001 * windowheight / windowwidth;
	var t = 0.001 * windowheight / windowwidth;
	var n = 0.001;
	var f = 1000000.0;
	//logtoall("%f,%f,%f,%f,%f,%f\n",l,r,b,t,n,f);

	projmatrix[ 0] = 2 * n / (r-l);
	projmatrix[ 1] = 0.0;
	projmatrix[ 2] = (r+l) / (l-r);
	projmatrix[ 3] = 0.0;

	projmatrix[ 4] = 0.0;
	projmatrix[ 5] = 2 * n / (t-b);
	projmatrix[ 6] = (t+b) / (b-t);
	projmatrix[ 7] = 0.0;

	projmatrix[ 8] = 0.0;
	projmatrix[ 9] = 0.0;
	projmatrix[10] = f / (f-n);
	projmatrix[11] = f * n / (n-f);

	projmatrix[12] = 0.0;
	projmatrix[13] = 0.0;
	projmatrix[14] = 1.0;
	projmatrix[15] = 0.0;

	projinverse[ 0] = 0.5 * (r-l) / n;
	projinverse[ 1] = 0.0;
	projinverse[ 2] = 0.0;
	projinverse[ 3] = 0.5 * (r+l) / n;

	projinverse[ 4] = 0.0;
	projinverse[ 5] = 0.5 * (t-b) / n;
	projinverse[ 6] = 0.0;
	projinverse[ 7] = 0.5 * (t+b) / n;

	projinverse[ 8] = 0.0;
	projinverse[ 9] = 0.0;
	projinverse[10] = 0.0;
	projinverse[11] = 1.0;

	projinverse[12] = 0.0;
	projinverse[13] = 0.0;
	projinverse[14] = (n-f) / n / f;
	projinverse[15] = 1.0 / n;
}
function quaternion_rotatefrom(v, q)
{
	let t=[
		(q[1]*v[2]-q[2]*v[1]) * 2,
		(q[2]*v[0]-q[0]*v[2]) * 2,
		(q[0]*v[1]-q[1]*v[0]) * 2];

	let o=[
		v[0] + q[3]*t[0] + q[1]*t[2]-q[2]*t[1],
		v[1] + q[3]*t[1] + q[2]*t[0]-q[0]*t[2],
		v[2] + q[3]*t[2] + q[0]*t[1]-q[1]*t[0]];
	return o;
}

function setcamera()
{
	var camxyz = new Float32Array([camerax, cameray, cameraz]);
	gl.uniform3fv(gl.getUniformLocation(shaderProgram, "camxyz"), camxyz);

	setmatrix_view();
	setprojmatrix();
	gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, "view"), true, viewmatrix);
	gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, "proj"), true, projmatrix);
}

function setlight()
{
	//var ambientcolor = new Float32Array([0.2, 0.2, 0.2]);
	//var diffusecolor = new Float32Array([0.8, 0.8, 0.8]);
	//var diffuseplace = new Float32Array([0.0, 0.0, 10.0]);
	//gl.uniform3fv(gl.getUniformLocation(shaderProgram, "ambientcolor"), ambientcolor);
	//gl.uniform3fv(gl.getUniformLocation(shaderProgram, "diffusecolor"), diffusecolor);
	//gl.uniform3fv(gl.getUniformLocation(shaderProgram, "diffuseplace"), diffuseplace);
}
function drawScene()
{
	//setup
	gl.enable(gl.DEPTH_TEST);
	gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	gl.viewport(0, 0, windowwidth, windowheight);

	//matrix
	setcamera();
	setlight();

	//draw axis
	setmatrix_model(0);

	gl.bindBuffer(gl.ARRAY_BUFFER, axishandle);
	gl.disableVertexAttribArray(normalobject);

	gl.vertexAttribPointer(positionobject, 3, gl.FLOAT, false, 24, 0);
	gl.enableVertexAttribArray(positionobject);

	gl.vertexAttribPointer(colorobject, 3, gl.FLOAT, false, 24, 12);
	gl.enableVertexAttribArray(colorobject);

	gl.drawArrays(gl.LINES, 0, 6);

	//draw shape
	setmatrix_model(1);

	if(stlpointcount == 0)
	{
		gl.bindBuffer(gl.ARRAY_BUFFER, vertexhandle);

		gl.vertexAttribPointer(positionobject, 3, gl.FLOAT, false, 36, 0);
		gl.enableVertexAttribArray(positionobject);

		gl.vertexAttribPointer(normalobject, 3, gl.FLOAT, false, 36, 12);
		gl.enableVertexAttribArray(normalobject);

		gl.vertexAttribPointer(colorobject, 3, gl.FLOAT, false, 36, 24);
		gl.enableVertexAttribArray(colorobject);

		gl.drawElements(gl.TRIANGLES, 3*12, gl.UNSIGNED_SHORT, 0);
	}

	//draw stl
	else
	{
		gl.bindBuffer(gl.ARRAY_BUFFER, stlhandle);

		gl.vertexAttribPointer(positionobject, 3, gl.FLOAT, false, 36, 12);
		gl.enableVertexAttribArray(positionobject);

		gl.vertexAttribPointer(normalobject, 3, gl.FLOAT, false, 36, 0);
		gl.enableVertexAttribArray(normalobject);

		gl.vertexAttribPointer(colorobject, 3, gl.FLOAT, false, 36, 24);
		gl.enableVertexAttribArray(colorobject);

		//gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, 3, gl.FLOAT, false, 24, 0);
		//gl.enableVertexAttribArray(shaderProgram.vertexNormalAttribute);

		gl.drawArrays(gl.TRIANGLES, 0, stlpointcount*3);
	}

	updateui_local2fb();
	updateui_fb2local();
}

function birth()
{
	resize();
	initwebgl();
	initshaders();

	//axis
	axishandle = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, axishandle);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(axisdata), gl.STATIC_DRAW);

	//cube
	vertexhandle = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, vertexhandle);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexdata), gl.STATIC_DRAW);

	indexhandle = gl.createBuffer();
	gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexhandle);
	gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Int16Array(indexdata), gl.STATIC_DRAW);

	var tick = function()
	{
		drawScene();
		requestAnimationFrame(tick);
	}
	tick();
}

function quaternion_rotate(v, q)
{
	var j = new Float32Array(4);
	var k = new Float32Array(4);
	j[0] = (q[1]*v[2]-q[2]*v[1]) * 2;
	j[1] = (q[2]*v[0]-q[0]*v[2]) * 2;
	j[2] = (q[0]*v[1]-q[1]*v[0]) * 2;

	k[0] = q[1]*j[2]-q[2]*j[1];
	k[1] = q[2]*j[0]-q[0]*j[2];
	k[2] = q[0]*j[1]-q[1]*j[0];

	v[0] += q[3]*j[0] + k[0];
	v[1] += q[3]*j[1] + k[1];
	v[2] += q[3]*j[2] + k[2];

	camerax = centerx + v[0];
	cameray = centery + v[1];
	cameraz = centerz + v[2];
}
function surroundrotatey(angle)
{
	//the vector
	var v = new Float32Array(4);
	v[0] = camerax - centerx;
	v[1] = cameray - centery;
	v[2] = cameraz - centerz;

	//the axis
	var q = new Float32Array(4);
	q[0] =-(cameray - centery);
	q[1] = (camerax - centerx);
	q[2] = 0.0;

	//fix quaternion
	var n = Math.sqrt(q[0]*q[0] + q[1]*q[1] + q[2]*q[2]);
	var c = Math.cos(angle/2);	//divide by 2: it's quaternion
	var s = Math.sin(angle/2);
	q[0] = q[0]*s/n;
	q[1] = q[1]*s/n;
	q[2] = q[2]*s/n;
	q[3] = c;

	quaternion_rotate(v, q);
}
function surroundrotatex(angle)
{
	var x = camerax - centerx;
	var y = cameray - centery;
	var c = Math.cos(angle);
	var s = Math.sin(angle);
	camerax = centerx + c*x - s*y;
	cameray = centery + s*x + c*y;
}

var flag=0;
var oldx;
var oldy;
function keydown(ev)
{
	var k = ev.keyCode;
	//console.log(k);
	if(k == 32){
		centerx = centery = centerz = 0.0;
		camerax =  0.0;
		cameray =-10.0;
		cameraz = 10.0;
	}else if(k == 37){
		centerx -= 1;
		camerax -= 1;
	}else if(k == 39){
		centerx += 1;
		camerax += 1;
	}else if(k == 38){
		centery += 1;
		cameray += 1;
	}else if(k == 40){
		centery -= 1;
		cameray -= 1;
	}else if(k ==187){
		centerz += 1;
		cameraz += 1;
	}else if(k ==189){
		centerz -= 1;
		cameraz -= 1;
	}
}
function mousewheel(ev)
{
	var tx=camerax;
	var ty=cameray;
	var tz=cameraz;
	if(ev.deltaY < 0)
	{
		camerax = 0.9*tx + 0.1*centerx;
		cameray = 0.9*ty + 0.1*centery;
		cameraz = 0.9*tz + 0.1*centerz;
	}
	else
	{
		camerax = 1.1*tx - 0.1*centerx;
		cameray = 1.1*ty - 0.1*centery;
		cameraz = 1.1*tz - 0.1*centerz;
	}
	updated_camera = 0;
}
function mousedown(ev)
{
	flag = 1;
	oldx = ev.clientX;
	oldy = ev.clientY;
}
function mouseup(ev)
{
	updated_camera = 0;
	flag = 0;
}
function mousemove(ev)
{
	if(flag == 0)return;

	newx = ev.clientX;
	newy = ev.clientY;
	if(newx < oldx)surroundrotatex( 0.05);
	if(newx > oldx)surroundrotatex(-0.05);
	if(newy < oldy)surroundrotatey( 0.05);
	if(newy > oldy)surroundrotatey(-0.05);
	oldx = newx;
	oldy = newy;

	updated_camera = 0;
}
function touchmove(ev)
{
	if(flag == 0)return;

	var t = ev.touches[0];
	newx = t.clientX;
	newy = t.clientY;
	if(newx < oldx)surroundrotatex( 0.05);
	if(newx > oldx)surroundrotatex(-0.05);
	if(newy < oldy)surroundrotatey( 0.05);
	if(newy > oldy)surroundrotatey(-0.05);
	oldx = newx;
	oldy = newy;
}
function model_aa_keydown(ev)
{
	if (ev.key === 'Enter') {
		console.log(ev);
		ev.preventDefault();

		let text = document.getElementById("model_axisangle_textarea").value;
		console.log(text);
		if(text==null)return;

		let arr = text.split(/\s+/);
		console.log(arr);
		if(arr.length < 4)return;

		model_axan = arr.slice(0, 4).map(value => parseFloat(value));
		console.log(model_axan);
		updated_model = 0;
	}
}
function camera_aa_keydown(ev)
{
	if (ev.key === 'Enter') {
		console.log(ev);
		ev.preventDefault();

		let text = document.getElementById("camera_axisangle_textarea").value;
		console.log(text);
		if(text==null)return;

		let arr = text.split(/\s+/);
		console.log(arr);
		if(arr.length < 4)return;

		camera_axan = arr.slice(0, 4).map(value => parseFloat(value));
		console.log(camera_axan);
		updated_model = 0;
	}
}

var updated_model = 0;
function updateui_model(aa)
{
	if(updated_model==1){
		return;
	}
	updated_model=1

	let str = '';
	str += aa[0].toFixed(3) + ', ';
	str += aa[1].toFixed(3) + ', ';
	str += aa[2].toFixed(3) + ', ';
	str += aa[3].toFixed(3);
	document.getElementById('model_axisangle_textarea').value = str;

	//
	str = '';
	str += model_quat[0].toFixed(3) + ', ';
	str += model_quat[1].toFixed(3) + ', ';
	str += model_quat[2].toFixed(3) + ', ';
	str += model_quat[3].toFixed(3);
	document.getElementById('model_quaternion_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(modelmatrix[j] >= 0)str += ' ';
		str += modelmatrix[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('model_matrix_textarea').value = str;
}

var updated_camera = 0;
function updateui_camera()
{
	if(updated_camera==1){
		return;
	}
	updated_camera=1

	let str = '';
	str += camerax.toFixed(3) + ', ';
	str += cameray.toFixed(3) + ', ';
	str += cameraz.toFixed(3);
	document.getElementById('camera_position_textarea').value = str;

	str = '';
	str += camera_axan[0].toFixed(3) + ', ';
	str += camera_axan[1].toFixed(3) + ', ';
	str += camera_axan[2].toFixed(3) + ', ';
	str += camera_axan[3].toFixed(3);
	document.getElementById('camera_axisangle_textarea').value = str;

	//
	str = '';
	str += camera_quat[0].toFixed(3) + ', ';
	str += camera_quat[1].toFixed(3) + ', ';
	str += camera_quat[2].toFixed(3) + ', ';
	str += camera_quat[3].toFixed(3);
	document.getElementById('camera_quaternion_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(viewmatrix[j] >= 0)str += ' ';
		str += viewmatrix[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('camera_matrix_textarea').value = str;
}

fbxy = new Float32Array([
	0.0, 0.0, 1.0, 20.0
]);
function updateui_local2fb(){
	let vec = [1, 1, 1, 1];
	//let tmp = quaternion_rotatefrom(vec, model_quat);
	//console.log(tmp);

	let w_vec = [
		modelmatrix[ 0]*vec[0] + modelmatrix[ 1]*vec[1] + modelmatrix[ 2]*vec[2] + modelmatrix[ 3]*vec[3],
		modelmatrix[ 4]*vec[0] + modelmatrix[ 5]*vec[1] + modelmatrix[ 6]*vec[2] + modelmatrix[ 7]*vec[3],
		modelmatrix[ 8]*vec[0] + modelmatrix[ 9]*vec[1] + modelmatrix[10]*vec[2] + modelmatrix[11]*vec[3],
		modelmatrix[12]*vec[0] + modelmatrix[13]*vec[1] + modelmatrix[14]*vec[2] + modelmatrix[15]*vec[3]
	];

	let v_w_vec = [
		viewmatrix[ 0]*w_vec[0] + viewmatrix[ 1]*w_vec[1] + viewmatrix[ 2]*w_vec[2] + viewmatrix[ 3]*w_vec[3],
		viewmatrix[ 4]*w_vec[0] + viewmatrix[ 5]*w_vec[1] + viewmatrix[ 6]*w_vec[2] + viewmatrix[ 7]*w_vec[3],
		viewmatrix[ 8]*w_vec[0] + viewmatrix[ 9]*w_vec[1] + viewmatrix[10]*w_vec[2] + viewmatrix[11]*w_vec[3],
		viewmatrix[12]*w_vec[0] + viewmatrix[13]*w_vec[1] + viewmatrix[14]*w_vec[2] + viewmatrix[15]*w_vec[3]
	];
/*	let v_w_vec = [
		viewmatrix[ 0]*w_vec[0] + viewmatrix[ 4]*w_vec[1] + viewmatrix[ 8]*w_vec[2] + viewmatrix[12]*w_vec[3],
		viewmatrix[ 1]*w_vec[0] + viewmatrix[ 5]*w_vec[1] + viewmatrix[ 9]*w_vec[2] + viewmatrix[13]*w_vec[3],
		viewmatrix[ 2]*w_vec[0] + viewmatrix[ 5]*w_vec[1] + viewmatrix[10]*w_vec[2] + viewmatrix[14]*w_vec[3],
		viewmatrix[ 3]*w_vec[0] + viewmatrix[ 7]*w_vec[1] + viewmatrix[11]*w_vec[2] + viewmatrix[15]*w_vec[3]
	];*/

	let p_v_w_vec = [
		projmatrix[ 0]*v_w_vec[0] + projmatrix[ 1]*v_w_vec[1] + projmatrix[ 2]*v_w_vec[2] + projmatrix[ 3]*v_w_vec[3],
		projmatrix[ 4]*v_w_vec[0] + projmatrix[ 5]*v_w_vec[1] + projmatrix[ 6]*v_w_vec[2] + projmatrix[ 7]*v_w_vec[3],
		projmatrix[ 8]*v_w_vec[0] + projmatrix[ 9]*v_w_vec[1] + projmatrix[10]*v_w_vec[2] + projmatrix[11]*v_w_vec[3],
		projmatrix[12]*v_w_vec[0] + projmatrix[13]*v_w_vec[1] + projmatrix[14]*v_w_vec[2] + projmatrix[15]*v_w_vec[3]
	];
/*
	let p_v_w_vec = [
		projmatrix[ 0]*v_w_vec[0] + projmatrix[ 4]*v_w_vec[1] + projmatrix[ 8]*v_w_vec[2] + projmatrix[12]*v_w_vec[3],
		projmatrix[ 1]*v_w_vec[0] + projmatrix[ 5]*v_w_vec[1] + projmatrix[ 9]*v_w_vec[2] + projmatrix[13]*v_w_vec[3],
		projmatrix[ 2]*v_w_vec[0] + projmatrix[ 6]*v_w_vec[1] + projmatrix[10]*v_w_vec[2] + projmatrix[14]*v_w_vec[3],
		projmatrix[ 3]*v_w_vec[0] + projmatrix[ 7]*v_w_vec[1] + projmatrix[11]*v_w_vec[2] + projmatrix[15]*v_w_vec[3]
	];
*/
	let ndc = [p_v_w_vec[0]/p_v_w_vec[3], p_v_w_vec[1]/p_v_w_vec[3], p_v_w_vec[2]/p_v_w_vec[3], 1.0];
	let vpxy = [(ndc[0]+1)/2, 1-(ndc[1]+1)/2, ndc[2], ndc[3]];
	fbxy = [windowwidth*vpxy[0], windowheight*vpxy[1], ndc[2], 1];

	//
	let str = '';
	for(let j=0;j<16;j++){
		if(projmatrix[j] >= 0)str += ' ';
		str += projmatrix[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('proj_matrix_full_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(viewmatrix[j] >= 0)str += ' ';
		str += viewmatrix[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('camera_matrix_full_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(modelmatrix[j] >= 0)str += ' ';
		str += modelmatrix[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('model_matrix_full_textarea').value = str;

	//
	str = '';
	str += vec[0].toFixed(3) + '\n';
	str += vec[1].toFixed(3) + '\n';
	str += vec[2].toFixed(3) + '\n';
	str += vec[3].toFixed(3);
	document.getElementById('local_position_textarea').value = str;

	//
	str = '';
	str += w_vec[0].toFixed(3) + '\n';
	str += w_vec[1].toFixed(3) + '\n';
	str += w_vec[2].toFixed(3) + '\n';
	str += w_vec[3].toFixed(3);
	document.getElementById('world_position_textarea').value = str;

	//
	str = '';
	str += v_w_vec[0].toFixed(3) + '\n';
	str += v_w_vec[1].toFixed(3) + '\n';
	str += v_w_vec[2].toFixed(3) + '\n';
	str += v_w_vec[3].toFixed(3);
	document.getElementById('view_position_textarea').value = str;

	//
	str = '';
	str += p_v_w_vec[0].toFixed(3) + '\n';
	str += p_v_w_vec[1].toFixed(3) + '\n';
	str += p_v_w_vec[2].toFixed(3) + '\n';
	str += p_v_w_vec[3].toFixed(3);
	document.getElementById('clip_position_textarea').value = str;

	//
	str = '';
	str += ndc[0].toFixed(3) + '\n';
	str += ndc[1].toFixed(3) + '\n';
	str += ndc[2].toFixed(3) + '\n';
	str += ndc[3].toFixed(3);
	document.getElementById('ndc_position_textarea').value = str;

	str = '';
	str += vpxy[0].toFixed(3) + '\n';
	str += vpxy[1].toFixed(3) + '\n';
	str += vpxy[2].toFixed(3) + '\n';
	str += vpxy[3].toFixed(3);
	document.getElementById('vp_position_textarea').value = str;

	//
	str = '';
	str += fbxy[0].toFixed(3) + '\n';
	str += fbxy[1].toFixed(3) + '\n';
	str += fbxy[2].toFixed(3) + '\n';
	str += fbxy[3].toFixed(3);
	document.getElementById('fb_position_textarea').value = str;
}
function updateui_fb2local(){
	let vpxy = [fbxy[0]/windowwidth, fbxy[1]/windowheight, fbxy[2], fbxy[3]];
	let ndc = [vpxy[0]*2-1, 1-vpxy[1]*2, vpxy[2], vpxy[3]];

	let view = [
		projinverse[ 0]*ndc[0] + projinverse[ 1]*ndc[1] + projinverse[ 2]*ndc[2] + projinverse[ 3]*ndc[3],
		projinverse[ 4]*ndc[0] + projinverse[ 5]*ndc[1] + projinverse[ 6]*ndc[2] + projinverse[ 7]*ndc[3],
		projinverse[ 8]*ndc[0] + projinverse[ 9]*ndc[1] + projinverse[10]*ndc[2] + projinverse[11]*ndc[3],
		projinverse[12]*ndc[0] + projinverse[13]*ndc[1] + projinverse[14]*ndc[2] + projinverse[15]*ndc[3]
	];
	view = [view[0]/view[3], view[1]/view[3], view[2]/view[3], 1];

	let world = [
		camerainverse[ 0]*view[0] + camerainverse[ 1]*view[1] + camerainverse[ 2]*view[2] + camerainverse[ 3]*view[3],
		camerainverse[ 4]*view[0] + camerainverse[ 5]*view[1] + camerainverse[ 6]*view[2] + camerainverse[ 7]*view[3],
		camerainverse[ 8]*view[0] + camerainverse[ 9]*view[1] + camerainverse[10]*view[2] + camerainverse[11]*view[3],
		camerainverse[12]*view[0] + camerainverse[13]*view[1] + camerainverse[14]*view[2] + camerainverse[15]*view[3]
	];

	let local = [
		modelinverse[ 0]*world[0] + modelinverse[ 1]*world[1] + modelinverse[ 2]*world[2] + modelinverse[ 3]*world[3],
		modelinverse[ 4]*world[0] + modelinverse[ 5]*world[1] + modelinverse[ 6]*world[2] + modelinverse[ 7]*world[3],
		modelinverse[ 8]*world[0] + modelinverse[ 9]*world[1] + modelinverse[10]*world[2] + modelinverse[11]*world[3],
		modelinverse[12]*world[0] + modelinverse[13]*world[1] + modelinverse[14]*world[2] + modelinverse[15]*world[3]
	];

	str = '';
	str += vpxy[0].toFixed(3) + '\n';
	str += vpxy[1].toFixed(3) + '\n';
	str += vpxy[2].toFixed(3) + '\n';
	str += vpxy[3].toFixed(3);
	document.getElementById('vp_inverse_textarea').value = str;

	//
	str = '';
	str += ndc[0].toFixed(3) + '\n';
	str += ndc[1].toFixed(3) + '\n';
	str += ndc[2].toFixed(3) + '\n';
	str += ndc[3].toFixed(3);
	document.getElementById('ndc_inverse_textarea').value = str;

	str = 'same as ndc';
	document.getElementById('clip_inverse_textarea').value = str;

	str = '';
	str += view[0].toFixed(3) + '\n';
	str += view[1].toFixed(3) + '\n';
	str += view[2].toFixed(3) + '\n';
	str += view[3].toFixed(3);
	document.getElementById('view_inverse_textarea').value = str;

	str = '';
	str += world[0].toFixed(3) + '\n';
	str += world[1].toFixed(3) + '\n';
	str += world[2].toFixed(3) + '\n';
	str += world[3].toFixed(3);
	document.getElementById('world_inverse_textarea').value = str;

	str = '';
	str += local[0].toFixed(3) + '\n';
	str += local[1].toFixed(3) + '\n';
	str += local[2].toFixed(3) + '\n';
	str += local[3].toFixed(3);
	document.getElementById('local_inverse_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(projinverse[j] >= 0)str += ' ';
		str += projinverse[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('proj_inverse_full_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(camerainverse[j] >= 0)str += ' ';
		str += camerainverse[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('camera_inverse_full_textarea').value = str;

	//
	str = '';
	for(let j=0;j<16;j++){
		if(modelinverse[j] >= 0)str += ' ';
		str += modelinverse[j].toFixed(3);
		str += ((j%4)==3) ? '\n' : ', ';
	}
	document.getElementById('model_inverse_full_textarea').value = str;
}
</script>

</body>
</html>
