<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8" />
<style>html,body{margin:0;padding:0;overflow:hidden;}</style>
<script id="vshader" type="x-shader/x-vertex">
attribute vec3 position;
varying vec4 vColor;
uniform mat4 model;
uniform mat4 view;
uniform mat4 proj;
void main(void) {
	vColor = vec4(position, 1.0);
	gl_Position = proj * view * model * vec4(position, 1.0);
}
</script>
<script id="fshader" type="x-shader/x-fragment">
precision mediump float;
varying vec4 vColor;
void main(void) {
	gl_FragColor = vColor;
}
</script>

<script type="text/javascript">
var windowwidth = 512;
var windowheight = 512;
function resize()
{
	windowidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
	windowheight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
	document.getElementById("canvas").width = windowwidth;
	document.getElementById("canvas").height = windowheight;
}

var gl;
function initGL(canvas) {
        var canvas = document.getElementById("canvas");
	try {
		gl = canvas.getContext("experimental-webgl");
	}
	catch (e) {
	}
	if (!gl) {
		alert("抱歉，不能初始化webGL！");
	}
}
function getShader(gl, id) {
	var shaderScript = document.getElementById(id);
	if(!shaderScript)return null;

	var str = "";
	var k = shaderScript.firstChild;
	while (k) {
		if (k.nodeType == 3)str += k.textContent;
		k = k.nextSibling;
	}

	var shader;
	if (shaderScript.type == "x-shader/x-fragment") {
		shader = gl.createShader(gl.FRAGMENT_SHADER);
	}
	else if (shaderScript.type == "x-shader/x-vertex") {
		shader = gl.createShader(gl.VERTEX_SHADER);
	}
	else return null;

	gl.shaderSource(shader, str);
	gl.compileShader(shader);

	if(!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
		alert(gl.getShaderInfoLog(shader));
	return null;
	}

	return shader;
}

var shaderProgram;
function initShaders() {
        var vertexShader = getShader(gl, "vshader");
        var fragmentShader = getShader(gl, "fshader");

        shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);

        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shaders");
        }

        gl.useProgram(shaderProgram);
        gl.enableVertexAttribArray(gl.getAttribLocation(shaderProgram, "position"));
}

var vertexbuffer;
var indexbuffer;
function initBuffers() {
        var vertices = [
		-0.25, -0.25, -0.5,
		0.25, -0.5, -0.5,
		0.5, 0.25, -0.5,
		-0.5, 0.5, -0.5,
		-0.5, -0.5, 0.5,
		0.5, -0.5, 0.5,
		0.5, 0.5, 0.5,
		-0.5, 0.5, 0.5
        ];
	var indexdata = [
		0, 1, 2,
		0, 2, 3,
		0, 1, 5,
		0, 4, 5,
		5, 6, 2,
		1, 2, 5,
		5, 6, 7,
		4, 5, 7,
		3, 7, 4,
		0, 3, 4,
		3, 7, 6,
		2, 3, 6
	];

	//
        vertexbuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, vertexbuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        vertexbuffer.itemSize = 3;
        vertexbuffer.numItems = 8;

	//
	indexbuffer = gl.createBuffer();
	gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexbuffer);
	gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Int16Array(indexdata), gl.STATIC_DRAW);
}

var camerax = 0.0;
var cameray = 2.0;
var cameraz = 0.0;
var centerx = 0.0;
var centery = 0.0;
var centerz = 0.0;
var abovex = 0.0;
var abovey = 0.0;
var abovez = 1.0;
modelmatrix = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0, 
	0.0, 0.0, 0.0, 1.0
]);
viewmatrix = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, 1.0, 0.0, 
	0.0, 0.0, 0.0, 1.0
]);
projmatrix = new Float32Array([
	1.0, 0.0, 0.0, 0.0,
	0.0, 1.0, 0.0, 0.0,
	0.0, 0.0, -1.0, -1.0,
	0.0, 0.0, -0.2, 0.0
]);
function setMatrixUniforms()
{
	var norm;

	//Z = center - camera
	var nx = centerx - camerax;
	var ny = centery - cameray;
	var nz = centerz - cameraz;
	norm = Math.sqrt(nx*nx + ny*ny + nz*nz);
	nx /= norm;
	ny /= norm;
	nz /= norm;

	//X = cross(Z, above)
	var ux = ny*abovez - nz*abovey;
	var uy = nz*abovex - nx*abovez;
	var uz = nx*abovey - ny*abovex;
	norm = Math.sqrt(ux*ux + uy*uy + uz*uz);
	ux /= norm;
	uy /= norm;
	uz /= norm;

	//above = cross(X, Z)
	var vx = uy*nz - uz*ny;
	var vy = uz*nx - ux*nz;
	var vz = ux*ny - uy*nx;

	viewmatrix[0] = ux;
	viewmatrix[1] = vx;
	viewmatrix[2] = -nx;
	viewmatrix[3] = 0.0;

	viewmatrix[4] = uy;
	viewmatrix[5] = vy;
	viewmatrix[6] = -ny;
	viewmatrix[7] = 0.0;

	viewmatrix[8] = uz;
	viewmatrix[9] = vz;
	viewmatrix[10] = -nz;
	viewmatrix[11] = 0.0;

	viewmatrix[12] = -camerax*ux - cameray*uy - cameraz*uz;
	viewmatrix[13] = -camerax*vx - cameray*vy - cameraz*vz;
	viewmatrix[14] = camerax*nx + cameray*ny + cameraz*nz;
	viewmatrix[15] = 1.0;

	projmatrix[5] = windowwidth / windowheight;
	gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, "model"), false, modelmatrix);
	gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, "view"), false, viewmatrix);
	gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, "proj"), false, projmatrix);
}

function drawScene()
{
        gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.clear(gl.COLOR_BUFFER_BIT);

        gl.bindBuffer(gl.ARRAY_BUFFER, vertexbuffer);
        gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, vertexbuffer.itemSize, gl.FLOAT, false, 0, 0);

        gl.viewport(0, 0, windowwidth, windowheight);
	setMatrixUniforms();
	gl.drawElements(gl.TRIANGLES, 36, gl.UNSIGNED_SHORT, 0);
        //gl.drawArrays(gl.TRIANGLES, 0, 6);
}

function birth()
{
	resize();
        initGL();
        initShaders();
        initBuffers();

        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        gl.enable(gl.DEPTH_TEST);

	var tick = function()
	{
		drawScene();
		requestAnimationFrame(tick);
	}
	tick();
}
function keydown()
{
	var tx = camerax;
	var ty = cameray;
	camerax = Math.cos(0.1)*tx + Math.sin(0.1)*ty;
	cameray = -Math.sin(0.1)*tx + Math.cos(0.1)*ty;
}
</script>
</head>

<body onload="birth()" onresize="resize()" onkeydown="keydown()" onmousemove="keydown()" ontouchmove="keydown()">
    <canvas id="canvas" style="border:none;width:100%;height:100%;"></canvas>
</body>

</html>
