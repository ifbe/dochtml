<html>
<head>
<meta charset="UTF-8">
<script src="js/cryptojs/rollups/sha1.js"></script>
<script src="js/threejs/three.js"></script>
<script type="text/javascript">
function say(data)
{
	var debug=document.getElementById("debug");
	debug.textContent=debug.textContent+data+"\n";
	debug.scrollTop=debug.scrollHeight;
	console.log(data);
}
var stage=0;
var ws;
function send(data)
{
	//say(data);
	if(stage>0)ws.send(data);
}
function sendbin(data)
{
	//var bin = new Uint8Array(1024*1024*3);
	//for (var i = 0; i < 1024*1024; i+=3) {
		//do something
	//}
	//ws.send(bin.buffer);
}
function sendblob(data)
{
	//var file = document.querySelector('input[type="file"]').files[0];
	//ws.send(file);
}
function start()
{
	var server=document.getElementById("server").value;
	var port=document.getElementById("port").value;
	var username=document.getElementById("username").value;
	var password=document.getElementById("password").value;

	var url="ws://"+server+":"+port;
	ws=new WebSocket(url);
	ws.binaryType = 'arraybuffer';

	ws.onmessage=function(event)
	{
		if(typeof event.data === "string")
		{
			if(stage==0x10)
			{
				//recv server_identity
				say("[stage0][server]"+event.data);

				//send username
				send(username);
				say("[stage1][client]username="+username);

				stage=0x11;
			}
			else if(stage==0x11)
			{
				//recv fixed_salt temp_salt
				say("[stage1][server]challenge="+event.data);

				//send md5(temp_salt + md5(fixed_salt + password))
				var arr=event.data.split(",");
				var hash1=CryptoJS.SHA1(arr[0] + password);
				say("	"+hash1);
				var hash2=CryptoJS.SHA1(arr[1] + hash1);
				say("	"+hash2);

				send(hash2);
				say("[stage2][client]response="+hash2);

				stage=0x12;
			}
			else if(stage==0x12)
			{
				send("haha");
				say("[stage2][server]status="+event.data);
				stage=31;
			}
			else if(stage==31)
			{
				draw(event.data);
			}
		}
		else //if(event.data instanceof ArrayBuffer)
		{
			pixel(event.data);
		}
	};
	ws.onopen=function(event)
	{
		stage=16;
		say("onopen:"+url);

		var str="final answer?";
		send(str);
		say("[stage0][client]" + str);
	};
	ws.onclose=function(event)
	{
		say("connection closed:"+event.code);
	};
	ws.onerror=function(event)
	{
		say("something wrong");
	};
}
window.onresize=function(){
	var w = window.innerWidth
	|| document.documentElement.clientWidth
	|| document.body.clientWidth;

	var h = window.innerHeight
	|| document.documentElement.clientHeight
	|| document.body.clientHeight;

	//updatesize(w,h);
}
window.onload=function() {
	var f0=document.getElementById("f0");
	var f1=document.getElementById("f1");
	var f2=document.getElementById("f2");
	var f3=document.getElementById("f3");
	f0.style.display="";
	f1.style.display="none";
	f2.style.display="none";
	f3.style.display="none";
	document.onkeydown=function(ev)
	{
		var k=ev.keyCode;
		//say("char "+k);

		if(k==8)			//back
		{
			event.preventDefault();
		}
		else if(k==9)		//tab
		{
			event.preventDefault();
		}
		else if(k==13)		//enter
		{
		}
		else if(k==27)		//esc
		{
		}
		else if(k==32)		//space
		{
		}
		else if(k>=37&&k<=40)	//l,u,r,d
		{
			event.preventDefault();
			send("char "+k);
		}
		else if(k>=48&&k<=57)	//[0,9](mainarea)
		{
		}
		else if(k>=65&&k<=90)	//[a,z]
		{
			k=k+32;
		}
		else if(k>=96&&k<=105)	//[0,9](keypad)
		{
			k=k-48;
		}
		else if(k>=106&&k<=111)	//*+
		{
			k-=64;
		}
		else if(k>=112&&k<=115)	//f1,f2,f3,f4
		{
			event.preventDefault();

			if(k==112)
			{
				f0.style.display="none";
				f1.style.display="";
				f2.style.display="none";
				f3.style.display="none";
			}
			else if(k==113)
			{
				f0.style.display="none";
				f1.style.display="none";
				f2.style.display="";
				f3.style.display="none";
			}
			else if(k==114)
			{
				f0.style.display="none";
				f1.style.display="none";
				f2.style.display="none";
				f3.style.display="";
			}
			else
			{
				f0.style.display="";
				f1.style.display="none";
				f2.style.display="none";
				f3.style.display="none";
			}
		}
		else if(k==187)
		{
		}
		else
		{
		}
	}
}
</script>

<style>
html,body{
	margin:0;
	padding:0;
	overflow:hidden;
}

#f0 {
	position:absolute;
	width:100%;
	height:100%;
	opacity:0.8;
	background:#444;
	box-shadow:2px 2px 4px #eee;
}
#menu {
	color:#fff;
	font-size:64px;
	text-align:center;
}

#f1 {
	white-space:pre-wrap;
	white-space:-moz-pre-wrap;
	white-space:-pre-wrap;
	white-space:-o-pre-wrap;
	word-wrap:break-word;
}
#debug {
	position:absolute;
	left:0%;
	top:0%;
	width:100%;
	height:100%;
	color:#fff;
	background:#444;
	overflow-y:scroll;
}

#f2 {
	position:absolute;
	width:100%;
	height:100%;
	opacity:0.8;
	color:#fff;
	background:#444;
	box-shadow:2px 2px 4px #eee;
}
#pixel {
	text-align:center;
}

#f3 {
	position:absolute;
	width:100%;
	height:100%;
	opacity:0.8;
	color:#fff;
	background:#444;
	box-shadow:2px 2px 4px #eee;
}
#scene {
	text-align:center;
}
</style>
</head>




<body>

<!-- this is login menu -->
<div id="f0">
	<div id="menu">
		<br />
		server:<input type="text" id="server" value="127.0.0.1" /><br />
		port:<input type="text" id="port" value="2222" /><br />
		username:<input type="text" id="username" value="42" /><br />
		password:<input type="password" id="password" value="42" /><br />
		<input type="submit" value="play" onclick="start()" />
	</div>
</div>

<!-- (dimension=1)(text console) -->
<pre id="f1">
	<code id="debug">
	</code>
</pre>

<!-- (dimension=2)(canvas pixel) -->
<div id="f2">
	<canvas id="pixel" width="512" height="512">
	</canvas>
	<script type="text/javascript">
		var canvas=document.getElementById('pixel');
		var ctx=canvas.getContext('2d');
		ctx.fillStyle='#FF0000';
		ctx.fillRect(100,200,300,400);
	</script>
</div>

<!-- (dimension=3)(webgl three.js) -->
<div id="f3">
	<h1 id="scene">haha</h1>
	<!--
	<script type="text/javascript">
		function threedim()
		{
		var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

		var renderer = new THREE.WebGLRenderer();
		renderer.setSize( window.innerWidth, window.innerHeight );
		document.body.appendChild( renderer.domElement );

		var geometry = new THREE.BoxGeometry( 1, 1, 1 );
		var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
		var cube = new THREE.Mesh( geometry, material );
		scene.add( cube );
		camera.position.z = 5;

		var render = function ()
		{
			requestAnimationFrame( render );

			cube.rotation.x += 0.1;
			cube.rotation.y += 0.1;
			renderer.render(scene, camera);
		};

		render();
		}
	</script>
	-->
</div>

</body>

</html>
